# Plan: PRD Export & Sharing

## Status: Completed (Backend) - Share page created, UI pending Plan 10 integration

## Overview
Allow users to export PRDs in multiple formats and share via expiring links.

## Implementation Steps

### 1. Export Formats

#### JSON Export
```typescript
// convex/prd.ts
// Use Convex storage to avoid response size limits
export const exportJSON = action({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.runQuery(internal.prd.get, { prdId: args.prdId });

    if (!prd) {
      throw new Error("PRD not found");
    }

    // Serialize PRD content
    const jsonContent = JSON.stringify(prd.content, null, 2);
    const blob = new Blob([jsonContent], { type: "application/json" });

    // Store in Convex storage
    const storageId = await ctx.storage.store(blob);

    // Update export timestamp
    await ctx.runMutation(internal.prd.markExported, { prdId: args.prdId });

    // Return storage reference for client to download
    return {
      storageId,
      filename: `${prd.content.projectOverview.productName}-PRD.json`,
    };
  },
});

// Internal mutation to mark as exported
export const markExported = internalMutation({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    await ctx.db.patch(args.prdId, {
      exportedAt: Date.now(),
    });
  },
});

// Client-side: get download URL
// const url = await ctx.storage.getUrl(storageId);
```

#### Markdown Export
```typescript
// lib/export/markdown.ts
export function prdToMarkdown(prd: PRDContent): string {
  return `# ${prd.projectOverview.productName}

## Project Overview
${prd.projectOverview.description}

**Target Audience:** ${prd.projectOverview.targetAudience}

## Purpose & Goals

### Problem Statement
${prd.purposeAndGoals.problemStatement}

### Solution
${prd.purposeAndGoals.solution}

### Key Objectives
${prd.purposeAndGoals.keyObjectives.map(o => `- ${o}`).join('\n')}

## User Personas
${prd.userPersonas.map(formatPersona).join('\n\n')}

## Tech Stack
${formatTechStack(prd.techStack)}

## Features

### MVP Features
${prd.features.mvpFeatures.map(formatFeature).join('\n\n')}

### Nice-to-Have Features
${prd.features.niceToHaveFeatures.map(formatFeature).join('\n\n')}

### Out of Scope
${prd.features.outOfScope.map(o => `- ${o}`).join('\n')}

## Technical Architecture

### System Design
${prd.technicalArchitecture.systemDesign}

### Data Models
${prd.technicalArchitecture.dataModels.map(formatDataModel).join('\n\n')}

### API Structure
${prd.technicalArchitecture.apiStructure}

### Third-Party Integrations
${prd.technicalArchitecture.thirdPartyIntegrations.map(i => `- ${i}`).join('\n')}

## UI/UX Considerations

### Design Approach
${prd.uiUxConsiderations.designApproach}

### Key User Flows
${prd.uiUxConsiderations.keyUserFlows.map((f, i) => `${i + 1}. ${f}`).join('\n')}

### Style Guidelines
${prd.uiUxConsiderations.styleGuidelines}

---
Generated by Just Start
`;
}
```

#### PDF Export
```typescript
// app/api/export/pdf/route.ts
import { jsPDF } from "jspdf";

export async function POST(req: Request) {
  const { prdId } = await req.json();

  // Get PRD from Convex
  const prd = await convex.query(api.prd.get, { prdId });

  // Generate PDF
  const doc = new jsPDF();

  // Add content with formatting
  doc.setFontSize(24);
  doc.text(prd.content.projectOverview.productName, 20, 30);

  // ... add all sections

  const pdfBuffer = doc.output("arraybuffer");

  return new Response(pdfBuffer, {
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${prd.content.projectOverview.productName}-PRD.pdf"`,
    },
  });
}
```

### 2. Sharing Functionality

#### Generate Share Token
```typescript
// convex/prd.ts
export const createShareLink = mutation({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.db.get(args.prdId);

    // Generate unique token
    const shareToken = generateToken();
    const expiresAt = Date.now() + 7 * 24 * 60 * 60 * 1000; // 7 days

    await ctx.db.patch(args.prdId, {
      shareToken,
      shareExpiresAt: expiresAt,
      shareAccessCount: 0,
      shareLastAccessedAt: null,
      shareRevokedAt: null,
    });

    // Use server-side env var (set in Convex dashboard, not .env.local)
    const appUrl = process.env.APP_URL;
    if (!appUrl) {
      throw new Error("APP_URL environment variable not configured in Convex dashboard");
    }

    return {
      url: `${appUrl}/share/${shareToken}`,
      expiresAt,
    };
  },
});

export const revokeShareLink = mutation({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    // Authenticate the user
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new Error("Authentication required: You must be logged in to revoke a share link");
    }

    // Load the PRD
    const prd = await ctx.db.get(args.prdId);
    if (!prd) {
      throw new Error("PRD not found: The requested PRD does not exist");
    }

    // Verify the current user is the PRD owner
    const user = await ctx.db
      .query("users")
      .withIndex("by_clerkId", (q) => q.eq("clerkId", identity.subject))
      .unique();
    
    if (!user || prd.userId !== user._id) {
      throw new Error("Permission denied: You do not have permission to revoke this share link");
    }

    // Revoke the share link
    await ctx.db.patch(args.prdId, {
      shareRevokedAt: Date.now(),
      shareToken: undefined,
      shareExpiresAt: undefined,
    });

    return { success: true };
  },
});

function generateToken(): string {
  // Generate 32 random bytes (256 bits) for high entropy
  const randomBytes = crypto.getRandomValues(new Uint8Array(32));
  
  // Convert to URL-safe base64 (no padding, replace + with -, / with _)
  const base64 = btoa(String.fromCharCode(...randomBytes))
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
  
  return base64;
}

// Note: Add APP_URL to Convex dashboard environment variables
// Example: APP_URL=https://yourapp.vercel.app
```

#### Share Page
```typescript
// app/share/[token]/page.tsx
export default async function SharePage({ params }) {
  const { token } = params;

  return (
    <Suspense fallback={<ShareLoader />}>
      <SharedPRD token={token} />
    </Suspense>
  );
}
```

#### Get Shared PRD
```typescript
// convex/prd.ts

// Read-only query - no writes allowed in queries
export const getShared = query({
  args: { token: v.string() },
  handler: async (ctx, args) => {
    const prd = await ctx.db
      .query("prds")
      .withIndex("by_share_token", (q) => q.eq("shareToken", args.token))
      .unique();

    if (!prd) {
      throw new Error("PRD not found");
    }

    // Check if link has been revoked
    if (prd.shareRevokedAt) {
      throw new Error("Share link has been revoked");
    }

    if (prd.shareExpiresAt && prd.shareExpiresAt < Date.now()) {
      throw new Error("Share link expired");
    }

    // Return read-only content
    return {
      content: prd.content,
      generatedAt: prd.generatedAt,
      prdId: prd._id, // Return ID so client can track access
    };
  },
});

// Separate mutation to track access (call from client after getShared)
export const trackShareAccess = mutation({
  args: { token: v.string() },
  handler: async (ctx, args) => {
    const prd = await ctx.db
      .query("prds")
      .withIndex("by_share_token", (q) => q.eq("shareToken", args.token))
      .unique();

    if (!prd) return; // Silently fail if not found

    await ctx.db.patch(prd._id, {
      shareAccessCount: (prd.shareAccessCount || 0) + 1,
      shareLastAccessedAt: Date.now(),
    });
  },
});

// Client usage:
// const sharedPrd = useQuery(api.prd.getShared, { token });
// const trackAccess = useMutation(api.prd.trackShareAccess);
// useEffect(() => { if (sharedPrd) trackAccess({ token }); }, [sharedPrd]);
```

### 3. UI Components

#### ExportDropdown
```typescript
// components/features/prd/export-dropdown.tsx
- Dropdown button "Export"
- Options:
  - Download JSON
  - Download Markdown
  - Download PDF
- Loading states for each
- Success toast on download
```

#### ShareDialog
```typescript
// components/features/prd/share-dialog.tsx
- "Share" button opens dialog
- Generate link button
- Show link with copy button
- Expiration date display
- "Copy" confirmation
- Revoke link option
```

#### CopyButton
```typescript
// components/ui/copy-button.tsx
- Copy to clipboard
- Shows "Copied!" feedback
- Returns to "Copy" after 2s
```

#### SharedPRDView
```typescript
// components/features/prd/shared-prd-view.tsx
- Read-only PRD display
- "Just Start" branding
- "Create your own" CTA
- No export for shared views
```

### 4. Download All
```typescript
// convex/prd.ts
export const downloadAll = action({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.runQuery(internal.prd.get, { prdId: args.prdId });

    // Create zip with all formats
    const zip = new JSZip();

    zip.file(
      `${prd.content.projectOverview.productName}-PRD.json`,
      JSON.stringify(prd.content, null, 2)
    );

    zip.file(
      `${prd.content.projectOverview.productName}-PRD.md`,
      prdToMarkdown(prd.content)
    );

    // Tech stack summary
    zip.file(
      "tech-stack-summary.md",
      generateTechStackSummary(prd.content.techStack)
    );

    return await zip.generateAsync({ type: "base64" });
  },
});
```

## UI/UX Design

### Export UX
- Clear format labels
- File size estimates
- Progress indicators
- Success confirmations

### Sharing UX
- Simple link generation
- Clear expiration info
- Easy copy action
- Revoke option visible

### Shared View
- Clean, professional look
- Mobile responsive
- Clear "read-only" indication
- CTA to create own PRD

## Dependencies
```json
{
  "jspdf": "^2.5.2",
  "jszip": "^3.10.1"
}
```

## Testing Checklist
- [ ] JSON export downloads correctly
- [ ] Markdown export is well-formatted
- [ ] PDF export is readable
- [ ] Share links generate correctly
- [ ] Share links expire after 7 days
- [ ] Shared PRDs display correctly
- [ ] Copy to clipboard works
- [ ] Download all creates valid zip

## Estimated Effort
Export & sharing: ~3-4 hours
