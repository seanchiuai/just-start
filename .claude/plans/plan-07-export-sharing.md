# Plan: PRD Export & Sharing

## Status: Not Started

## Overview
Allow users to export PRDs in multiple formats and share via expiring links.

## Implementation Steps

### 1. Export Formats

#### JSON Export
```typescript
// convex/prd.ts
export const exportJSON = mutation({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.db.get(args.prdId);

    await ctx.db.patch(args.prdId, {
      exportedAt: Date.now(),
    });

    return {
      filename: `${prd.content.projectOverview.productName}-PRD.json`,
      content: JSON.stringify(prd.content, null, 2),
      mimeType: "application/json",
    };
  },
});
```

#### Markdown Export
```typescript
// lib/export/markdown.ts
export function prdToMarkdown(prd: PRDContent): string {
  return `# ${prd.projectOverview.productName}

## Project Overview
${prd.projectOverview.description}

**Target Audience:** ${prd.projectOverview.targetAudience}

## Purpose & Goals

### Problem Statement
${prd.purposeAndGoals.problemStatement}

### Solution
${prd.purposeAndGoals.solution}

### Key Objectives
${prd.purposeAndGoals.keyObjectives.map(o => `- ${o}`).join('\n')}

## User Personas
${prd.userPersonas.map(formatPersona).join('\n\n')}

## Tech Stack
${formatTechStack(prd.techStack)}

## Features

### MVP Features
${prd.features.mvpFeatures.map(formatFeature).join('\n\n')}

### Nice-to-Have Features
${prd.features.niceToHaveFeatures.map(formatFeature).join('\n\n')}

### Out of Scope
${prd.features.outOfScope.map(o => `- ${o}`).join('\n')}

## Technical Architecture

### System Design
${prd.technicalArchitecture.systemDesign}

### Data Models
${prd.technicalArchitecture.dataModels.map(formatDataModel).join('\n\n')}

### API Structure
${prd.technicalArchitecture.apiStructure}

### Third-Party Integrations
${prd.technicalArchitecture.thirdPartyIntegrations.map(i => `- ${i}`).join('\n')}

## UI/UX Considerations

### Design Approach
${prd.uiUxConsiderations.designApproach}

### Key User Flows
${prd.uiUxConsiderations.keyUserFlows.map((f, i) => `${i + 1}. ${f}`).join('\n')}

### Style Guidelines
${prd.uiUxConsiderations.styleGuidelines}

---
Generated by Just Start
`;
}
```

#### PDF Export
```typescript
// app/api/export/pdf/route.ts
import { jsPDF } from "jspdf";

export async function POST(req: Request) {
  const { prdId } = await req.json();

  // Get PRD from Convex
  const prd = await convex.query(api.prd.get, { prdId });

  // Generate PDF
  const doc = new jsPDF();

  // Add content with formatting
  doc.setFontSize(24);
  doc.text(prd.content.projectOverview.productName, 20, 30);

  // ... add all sections

  const pdfBuffer = doc.output("arraybuffer");

  return new Response(pdfBuffer, {
    headers: {
      "Content-Type": "application/pdf",
      "Content-Disposition": `attachment; filename="${prd.content.projectOverview.productName}-PRD.pdf"`,
    },
  });
}
```

### 2. Sharing Functionality

#### Generate Share Token
```typescript
// convex/prd.ts
export const createShareLink = mutation({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.db.get(args.prdId);

    // Generate unique token
    const shareToken = generateToken();
    const expiresAt = Date.now() + 7 * 24 * 60 * 60 * 1000; // 7 days

    await ctx.db.patch(args.prdId, {
      shareToken,
      shareExpiresAt: expiresAt,
      shareAccessCount: 0,
      shareLastAccessedAt: null,
      shareRevokedAt: null,
    });

    return {
      url: `${process.env.NEXT_PUBLIC_APP_URL}/share/${shareToken}`,
      expiresAt,
    };
  },
});

function generateToken(): string {
  return crypto.randomUUID().replace(/-/g, "");
}
```

#### Share Page
```typescript
// app/share/[token]/page.tsx
export default async function SharePage({ params }) {
  const { token } = params;

  return (
    <Suspense fallback={<ShareLoader />}>
      <SharedPRD token={token} />
    </Suspense>
  );
}
```

#### Get Shared PRD
```typescript
// convex/prd.ts
export const getShared = query({
  args: { token: v.string() },
  handler: async (ctx, args) => {
    const prd = await ctx.db
      .query("prds")
      .withIndex("by_share_token", (q) => q.eq("shareToken", args.token))
      .unique();

    if (!prd) {
      throw new Error("PRD not found");
    }

    // Check if link has been revoked
    if (prd.shareRevokedAt) {
      throw new Error("Share link has been revoked");
    }

    if (prd.shareExpiresAt && prd.shareExpiresAt < Date.now()) {
      throw new Error("Share link expired");
    }

    // Update access metadata
    await ctx.db.patch(prd._id, {
      shareAccessCount: (prd.shareAccessCount || 0) + 1,
      shareLastAccessedAt: Date.now(),
    });

    // Return read-only content
    return {
      content: prd.content,
      generatedAt: prd.generatedAt,
    };
  },
});
```

### 3. UI Components

#### ExportDropdown
```typescript
// components/features/prd/export-dropdown.tsx
- Dropdown button "Export"
- Options:
  - Download JSON
  - Download Markdown
  - Download PDF
- Loading states for each
- Success toast on download
```

#### ShareDialog
```typescript
// components/features/prd/share-dialog.tsx
- "Share" button opens dialog
- Generate link button
- Show link with copy button
- Expiration date display
- "Copy" confirmation
- Revoke link option
```

#### CopyButton
```typescript
// components/ui/copy-button.tsx
- Copy to clipboard
- Shows "Copied!" feedback
- Returns to "Copy" after 2s
```

#### SharedPRDView
```typescript
// components/features/prd/shared-prd-view.tsx
- Read-only PRD display
- "Just Start" branding
- "Create your own" CTA
- No export for shared views
```

### 4. Download All
```typescript
// convex/prd.ts
export const downloadAll = action({
  args: { prdId: v.id("prds") },
  handler: async (ctx, args) => {
    const prd = await ctx.runQuery(internal.prd.get, { prdId: args.prdId });

    // Create zip with all formats
    const zip = new JSZip();

    zip.file(
      `${prd.content.projectOverview.productName}-PRD.json`,
      JSON.stringify(prd.content, null, 2)
    );

    zip.file(
      `${prd.content.projectOverview.productName}-PRD.md`,
      prdToMarkdown(prd.content)
    );

    // Tech stack summary
    zip.file(
      "tech-stack-summary.md",
      generateTechStackSummary(prd.content.techStack)
    );

    return await zip.generateAsync({ type: "base64" });
  },
});
```

## UI/UX Design

### Export UX
- Clear format labels
- File size estimates
- Progress indicators
- Success confirmations

### Sharing UX
- Simple link generation
- Clear expiration info
- Easy copy action
- Revoke option visible

### Shared View
- Clean, professional look
- Mobile responsive
- Clear "read-only" indication
- CTA to create own PRD

## Dependencies
```json
{
  "jspdf": "^2.5.2",
  "jszip": "^3.10.1"
}
```

## Testing Checklist
- [ ] JSON export downloads correctly
- [ ] Markdown export is well-formatted
- [ ] PDF export is readable
- [ ] Share links generate correctly
- [ ] Share links expire after 7 days
- [ ] Shared PRDs display correctly
- [ ] Copy to clipboard works
- [ ] Download all creates valid zip

## Estimated Effort
Export & sharing: ~3-4 hours
